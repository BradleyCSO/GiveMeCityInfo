@page
@using GiveMeCityInfo.Models;
@model GiveMeCityInfo.Pages.CitiesModel
@{
    int pageNumber;

    if (!int.TryParse(HttpContext.Request.Query["PageNumber"], out pageNumber))
    {
        pageNumber = 1;
    }
}

<form method="get">
    <!-- Continents -->
    <div class="continents form-group">
        <!-- Populated via JS-->
    </div>

    <!-- Countries -->
    <div class="countries form-group">
        <select multiple class="form-control countries-select" name="SelectedCountries" id="country">
            @if (Model.SelectedCountries.Any()) {
                foreach (var country in Model.SelectedCountries)
                {
                    <option selected="selected" value=@country>@country</option>
                }
            }
            @foreach (var country in Model?.Countries?.Except(Model.SelectedCountries) ?? new List<string>())
            {
                <option value="@country">@country</option>
            }
        </select>
    </div>

    <button id="submit" class="btn btn-primary" type="submit">Submit</button>
</form>

<div class="city-items container">
    @* Show filtered response *@
    @if (HttpContext.Request.Query.Any())
    {
        @foreach (var city in Model?.Cities?.Cities?.
                  Where(c => c.country == HttpContext.Request.Query["SelectedCountries"])
                  ?? new List<City>())
        {
            <p>@city?.name</p>
            <p>@city?.description</p>
        }
    }
    @* Otherwise show all items *@
    else
    {
        @foreach (var city in Model?.Cities?.Cities ?? new List<City>())
        {
            <p>@city?.name</p>
            <p>@city?.description</p>
        }
    }
</div>

@for (int i = 1; i <= Model?.Cities?.Pagination?.TotalPageCount; i++)
{
    <a
     asp-route-PageNumber="@(Model.Cities.Pagination.CurrentPage = i)"
   asp-route-SelectedCountries="@HttpContext.Request.Query.FirstOrDefault(d => d.Key == "SelectedCountries").Value"
   class="paginationButtons btn btn-default @(i == pageNumber ? "active" : string.Empty)">
        @i
    </a>
}

<script src="js/queryWebAPI.js" asp-append-version="true"></script>
<script>
    document.querySelector("form").addEventListener("submit", function (event) {
        event.preventDefault();
    });

    const paginationButtons = document.querySelectorAll(".paginationButtons");
    paginationButtons.forEach(paginationButton => {
        paginationButton.addEventListener('click', event => {
            event.preventDefault();

            // Clear old styles
            for (let i = 0; i < paginationButtons.length; i++)
            {
                paginationButtons[i].classList.remove("active");
            }

            // Add new active button style for now selected page
            event.currentTarget.classList.add("active");

            // Fetch paginated data based on button value

            // Clear old city items

            // Update with new items
        })
    })

    let apiData;

    // Fetch on change of page is a legitimate API call
    fetch(`${baseURI}`)
        .then(response => response.json())
        .then(data => {
            apiData = data;
        })
        .catch(error => console.error('Unable to get cities.', error));

    // Remove submit button
    document.querySelector('#submit').remove();

    let make = [];

    const continents = {
        Europe: "Europe",
        NorthAmerica: "North America"
    }

    for (const continent in continents) {
        document.getElementsByClassName("continents")[0].innerHTML += `<label class="form-check-label">${continent}</label>`
        document.getElementsByClassName("continents")[0].innerHTML += `<input checked="checked" type="checkbox" class="form-check-input" name="continent" id="continent" value="${continent}"</input>`
    }

    document.addEventListener('change', function (e) {
        // Change list of cities, update "card" elements based on city selected
        if (e.target && e.target.id == 'continent') {
            // Clear old options
            removeAllChildNodes(document.querySelector(".countries-select"));

            // Clear old activity items
            removeAllChildNodes(document.querySelector(".city-items"));

            // When continent changes, get values of all checked continent items and push them to array
            let continents = []
            document.querySelectorAll('input[type=checkbox]:checked').forEach(element => continents.push(element.value))
            //console.log(continents)
            let results = []

            if (continents.length > 0) {
                // Update option values based on selected continent(s)
                results = apiData.filter(element => {
                    return element.continent.includes(continents)
                })
            }

            // Update Option elements
            for (let i = 0; i < results.length; i++) {
                document.getElementsByClassName("countries-select")[0].innerHTML += `<option value=${results[i].country} class="form-check-label">${results[i].country}</option>`
            }

            // Update City items
            for (let i = 0; i < results.length; i++) {
                document.getElementsByClassName("city-items")[0].innerHTML += `<p>${results[i].name}</p>`
            }
        }
    });

    function removeAllChildNodes(parent) {
        while (parent.firstChild) {
            parent.removeChild(parent.firstChild);
        }
    }

    // Fetch data as this element will only appear with JS enabled
    // This is to ensure that one API call is made when JS is enabled
    // And one API call is made when JS is disabled
    //if (document.getElementsByClassName("continents").length > 0)
    //{
    //    yo = getCities((data) => console.log({ data }))
    //}

    // one leisure makes api call o

    // Get querystring values
    //const urlSearchParams = new URLSearchParams(window.location.search);
    //const params = Object.fromEntries(urlSearchParams.entries());
    //console.log(params)

    // Elements
    const country = document.getElementById("country");

    // Fill the form fields with corresponding queryString values
    //updateFormFieldValue(continent)
    //updateFormFieldValue(country)

    // Add event listener(s) to fetch API if elements change
    //document.querySelectorAll('#continent').forEach(item => {
    //    item.addEventListener('click', event => {
    //    })
    //})
    //document.querySelectorAll('#country').forEach(item => {
    //    item.addEventListener('click', event => {
    //        console.log(item)
    //    })
    //})

    const select = document.getElementById('continent');
    //console.log(select)
    let apiVals;
    select.addEventListener('change', function handleChange(event) {
        //console.log(event.target.value);
        getCities(function (data) {

            apiVals = data;
        })
    })




    // Update elements
    //async function fetchAPIEvent(event, element) {
    //    //event.preventDefault()

    //    const checkboxes = document.querySelectorAll('input[type=checkbox]:checked')
    //    for (let i = 0; i < checkboxes.length; i++) {
    //        await make.push(getCitiesByContinent(checkboxes[i].value))
    //    }

    //    // Get fields
    //    let country = document.getElementById("country");

    //    // Empty them to make way for new values
    //    country.innerHTML = ""
    //    // Add the new ones
    //    for (let i = 0; i < make.length; i++) {
    //    }
    //}

    function createElement() {

    }
    // Update form field values based on query string values
    function updateFormFieldValue(element) {
        if (element.value == params["continent"] || params["country"]) {
            if (element.getAttribute("type") == 'checkbox') {
                element.checked = true
            }
            else {
                element.value = params["country"]
            }
        }
    }

</script>